---
# Copyright 2016, Rackspace US, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Clone the role ansible-role-requirements
  hosts: localhost
  connection: local
  tasks:

    - name: Check whether zuul-cloner is installed and provide the path to it
      shell: |
        which zuul-cloner || { [[ -x /usr/zuul-env/bin/zuul-cloner ]] && echo '/usr/zuul-env/bin/zuul-cloner'; }
      args:
        executable: /bin/bash
      changed_when: false
      failed_when: false
      register: _zuul_cloner_check

    - name: Remove target directory if required
      shell: |
        if [[ ! -d "{{ item.path | default(homedir + '/.ansible/roles') }}/{{ item.name | default(item.src | basename) }}/.git" ]]; then
          rm -rf "{{ item.path | default(homedir + '/.ansible/roles') }}/{{ item.name | default(item.src | basename) }}"
        fi
      args:
        executable: /bin/bash
      when:
        - item.scm == "git" or item.scm is undefined
      with_items: "{{ roles }}"

    - name: Clone git repos (with git)
      git:
        repo: "{{ item.src }}"
        dest: "{{ homedir }}/.ansible/roles/{{ item.name | default(item.src | basename) }}"
        version: "{{ item.version | default('master') }}"
        update: true
        force: true
      when:
        - (_zuul_cloner_check.rc != 0) or (not item.src | match(".*git.openstack.org.*"))
        - item.scm == "git" or item.scm is undefined
      with_items: "{{ roles }}"

    - name: Create clone map
      copy:
        content: |
          clonemap:
            - name: 'openstack/openstack-ansible-(.*)'
              dest: '{{ homedir }}/.ansible/roles/\1'
        dest: "{{ homedir }}/.ansible/clonemap.yml"
      when:
        - _zuul_cloner_check.rc == 0

    - name: Clone git repos (with zuul-cloner)
      shell: |
        {{ _zuul_cloner_check.stdout }} \
                -m {{ homedir }}/.ansible/clonemap.yml \
                --cache-dir /opt/git \
                git://git.openstack.org \
        {% for src in roles | map(attribute='src') %}
        {%   if src | match(".*git.openstack.org.*") %}
                {{ src | regex_replace('https://git.openstack.org/', '') }} \
        {%   endif %}
        {% endfor %}
      when:
        - _zuul_cloner_check.rc == 0

  vars:
    role_file: "{{ toxinidir }}/tests/ansible-role-requirements.yml"
    roles: "{{ lookup('file', role_file) | from_yaml }}"
